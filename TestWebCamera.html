<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Test Web Camera</title>
    </head>
    <body>
        <div>
            <select id="cameraSelect"></select>
            <input type="button" value="Open" onclick="changeSelectedCamera()" />
        </div>
        <div>
            <video id="player" controls playsinline muted autoplay></video>
        </div>
        <script>
            const player = document.getElementById("player");
            const cameraSelect = document.getElementById("cameraSelect");

            function listCameras() {
                navigator.mediaDevices.enumerateDevices().then((devices) => {
                    cameraSelect.innerHTML = ""; // 既存のオプションをクリア
                    devices.forEach((device) => {
                        if (device.kind === "videoinput") {
                            const option = document.createElement("option");
                            option.value = device.deviceId;
                            option.textContent =
                                device.label ||
                                `カメラ ${cameraSelect.length + 1}`;
                            cameraSelect.appendChild(option);
                        }
                    });
                });
            }

            function requestCamera() {
                navigator.mediaDevices
                    .getUserMedia({ video: true })
                    .then((stream) => {
                        stream.getTracks().forEach((track) => track.stop()); // Use the stream to get permission and then stop it immediately
                        listCameras();
                    })
                    .catch((error) => {
                        console.error("エラー: ", error);
                        alert("カメラへのアクセス許可が拒否されました。");
                    });
            }

            function startCamera() {
                const constraints = {
                    video: {
                        deviceId: cameraSelect.value
                            ? { exact: cameraSelect.value }
                            : undefined,
                    },
                };
                navigator.mediaDevices
                    .getUserMedia(constraints)
                    .then((stream) => {
                        player.srcObject = stream;
                    })
                    .catch((error) => {
                        console.error("エラー: ", error);
                        alert("カメラへのアクセスに失敗しました。");
                    });
            }

            function stopCamera() {
                if (player.srcObject) {
                    player.srcObject.getTracks().forEach((track) => {
                        track.stop();
                    });
                    player.srcObject = null;
                }
            }

            function changeSelectedCamera() {
                if (player.srcObject) {
                    player.srcObject.getTracks().forEach((track) => {
                        track.stop();
                    });
                    player.srcObject = null;
                }
                startCamera();
            }

            // カメラの許可を表示
            requestCamera();

            // カメラの一覧を取得し、変更があったら再取得する
            navigator.mediaDevices.addEventListener("devicechange", (event) => {
                listCameras();
            });

            // ページが非表示になるときにカメラを停止する
            document.addEventListener("visibilitychange", (event) => {
                if (document.visibilityState === "hidden") {
                    stopCamera();
                }
            });

            // ページが閉じられるときにカメラを停止する
            window.addEventListener("beforeunload", (event) => {
                stopCamera();
            });
        </script>
    </body>
</html>
